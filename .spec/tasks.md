# Role-Based Access Control Bundle TDD 任务分解

## 任务概述

本文档将RBAC Bundle的实施分解为基于TDD方法的具体任务，遵循红-绿-重构循环。每个任务都包含明确的验收标准、测试场景和依赖关系。

## 任务统计
- 基础架构：6个任务
- 数据模型：4个任务  
- 核心服务：5个任务
- Symfony集成：4个任务
- CLI命令：4个任务
- 事件系统：3个任务

**总计：26个任务**

---

## 第一阶段：基础架构（6个任务）

### 任务 1: Bundle基础结构

#### 描述
创建Symfony Bundle的基础结构，包括Bundle类、DI扩展和服务配置。

#### 验收标准（基于 EARS）
- 当Bundle被注册到Symfony应用时，必须正确加载所有服务
- 如果环境变量缺失，Bundle必须使用合理的默认值
- Bundle必须能够在测试环境中正确初始化

#### TDD 实施步骤
1. **红色阶段**：编写Bundle注册和服务加载的失败测试
2. **绿色阶段**：创建RoleBasedAccessControlBundle类和Extension
3. **重构阶段**：优化服务配置和自动装配

#### 测试场景
- 单元测试：Bundle类路径正确性、Extension加载测试
- 集成测试：Bundle在Symfony内核中的注册测试
- 边缘案例：无效配置时的异常处理

#### 依赖关系
- 需要：无
- 阻塞：所有后续任务

---

### 任务 2: Composer配置和自动加载

#### 描述
配置composer.json以确保正确的命名空间和依赖管理。

#### 验收标准（基于 EARS）
- 当执行composer install时，所有类必须正确自动加载
- 包必须声明对Symfony 6.4+的依赖
- 开发依赖必须包含PHPStan Level 8和PHPUnit 11.5+

#### TDD 实施步骤
1. **红色阶段**：编写自动加载和依赖版本的测试
2. **绿色阶段**：配置composer.json的PSR-4和依赖
3. **重构阶段**：优化依赖版本约束

#### 测试场景
- 单元测试：类名到文件路径的映射正确性
- 集成测试：Composer自动加载功能测试
- 边缘案例：命名空间冲突检测

#### 依赖关系
- 需要：任务1（Bundle基础结构）
- 阻塞：任务3-26

---

### 任务 3: 异常类定义

#### 描述
创建RBAC专用的异常类体系，用于不同错误场景的精确处理。

#### 验收标准（基于 EARS）
- 当角色不存在时，必须抛出RoleNotFoundException
- 当权限不存在时，必须抛出PermissionNotFoundException  
- 当删除有关联的角色/权限时，必须抛出DeletionConflictException

#### TDD 实施步骤
1. **红色阶段**：编写各异常类的实例化和继承关系测试
2. **绿色阶段**：创建异常类及其构造函数
3. **重构阶段**：添加异常上下文信息和工厂方法

#### 测试场景
- 单元测试：每个异常类的构造和消息格式
- 集成测试：异常在业务场景中的正确抛出
- 边缘案例：异常链和嵌套异常处理

#### 依赖关系
- 需要：任务2（Composer配置）
- 阻塞：任务7-15（所有服务实现）

---

### 任务 4: PHPUnit测试配置

#### 描述
配置PHPUnit测试环境，包括测试数据库、内存数据库和测试工具类。

#### 验收标准（基于 EARS）
- 当运行phpunit时，必须能够在内存SQLite中执行所有测试
- 测试必须与生产数据库隔离
- 测试覆盖率必须达到90%以上

#### TDD 实施步骤
1. **红色阶段**：编写测试配置验证的测试
2. **绿色阶段**：创建phpunit.xml和测试基类
3. **重构阶段**：优化测试性能和数据清理

#### 测试场景
- 单元测试：测试配置文件解析正确性
- 集成测试：数据库Schema在测试中的创建
- 边缘案例：并发测试执行的数据隔离

#### 依赖关系
- 需要：任务2（Composer配置）
- 阻塞：任务7-26（所有需要测试的任务）

---

### 任务 5: 测试数据工厂

#### 描述
创建测试数据生成工具，用于在测试中快速创建角色、权限和用户关联。

#### 验收标准（基于 EARS）
- 当创建测试数据时，必须生成符合实际约束的有效数据
- 测试工厂必须支持关联数据的批量生成
- 每个测试用例必须有独立的数据集合

#### TDD 实施步骤
1. **红色阶段**：编写测试数据生成的验证测试
2. **绿色阶段**：实现TestDataTrait和工厂方法
3. **重构阶段**：添加复杂场景的数据生成支持

#### 测试场景
- 单元测试：单个实体创建的正确性
- 集成测试：关联实体创建的完整性
- 边缘案例：大量数据生成的性能测试

#### 依赖关系
- 需要：任务4（测试配置）
- 阻塞：任务8-26（所有需要测试数据的任务）

---

### 任务 6: 数据库Schema设计验证

#### 描述
通过Doctrine实体注解验证数据库Schema的正确性，确保索引和约束满足需求。

#### 验收标准（基于 EARS）
- 当执行数据库操作时，所有唯一约束必须正确执行
- 复合索引必须优化查询性能
- 外键约束必须保证数据完整性

#### TDD 实施步骤
1. **红色阶段**：编写Schema验证的测试用例
2. **绿色阶段**：创建Schema验证工具和测试
3. **重构阶段**：优化索引策略和性能测试

#### 测试场景
- 单元测试：每个索引和约束的SQL生成
- 集成测试：实际数据库操作的约束验证
- 边缘案例：约束违反时的异常处理

#### 依赖关系
- 需要：任务5（测试数据工厂）
- 阻塞：任务7-11（实体任务）

---

## 第二阶段：数据模型（4个任务）

### 任务 7: Role实体实现

#### 描述
实现Role实体，包含所有必需字段、Doctrine注解和预留的继承支持字段。

#### 验收标准（基于 EARS）
- 当创建Role时，code必须是全局唯一的
- 角色必须包含预留的parent_role_id和hierarchy_level字段
- created_at和updated_at必须自动管理

#### TDD 实施步骤
1. **红色阶段**：编写Role实体属性和方法的测试
2. **绿色阶段**：实现Role实体的贫血模型（仅getter/setter）
3. **重构阶段**：添加Doctrine注解和生命周期回调

#### 测试场景
- 单元测试：所有getter/setter方法的正确性
- 集成测试：Doctrine持久化和查询测试
- 边缘案例：唯一约束违反的异常处理

#### 依赖关系
- 需要：任务6（Schema验证）
- 阻塞：任务11（UserRole实体）、任务12（RoleRepository）

---

### 任务 8: Permission实体实现

#### 描述
实现Permission实体，提供权限码的存储和管理功能。

#### 验收标准（基于 EARS）
- 当创建Permission时，code必须遵循PERMISSION_*格式
- 权限码必须全局唯一
- 必须支持权限的描述和元数据存储

#### TDD 实施步骤
1. **红色阶段**：编写Permission实体的功能测试
2. **绿色阶段**：实现Permission实体类（贫血模型）
3. **重构阶段**：添加权限码格式验证和索引优化

#### 测试场景
- 单元测试：权限码格式验证和字段访问
- 集成测试：大量权限码的存储和查询性能
- 边缘案例：权限码命名冲突的处理

#### 依赖关系
- 需要：任务6（Schema验证）
- 阻塞：任务11（UserRole实体）、任务13（PermissionRepository）

---

### 任务 9: RolePermission关联实体

#### 描述
实现Role和Permission之间的多对多关联实体，支持权限授予的审计信息。

#### 验收标准（基于 EARS）
- 当为角色分配权限时，必须记录granted_at时间戳
- 同一角色-权限对必须只能存在一条记录
- 必须支持权限授予的批量操作

#### TDD 实施步骤
1. **红色阶段**：编写关联实体的唯一性和审计测试
2. **绿色阶段**：创建RolePermission实体和关联关系
3. **重构阶段**：优化批量操作的性能

#### 测试场景
- 单元测试：关联实体的创建和关联关系
- 集成测试：复合唯一约束的验证
- 边缘案例：并发权限分配的处理

#### 依赖关系
- 需要：任务7（Role实体）、任务8（Permission实体）
- 阻塞：任务14（PermissionManager服务）

---

### 任务 10: UserRole关联实体

#### 描述
实现User和Role之间的关联实体，支持用户角色分配的审计。

#### 验收标准（基于 EARS）
- 当为用户分配角色时，必须记录assigned_at时间戳
- 必须支持用户-角色的唯一性约束
- 必须与Symfony Security的UserInterface兼容

#### TDD 实施步骤
1. **红色阶段**：编写用户角色关联的测试
2. **绿色阶段**：创建UserRole实体和Symfony集成
3. **重构阶段**：优化用户权限查询的性能

#### 测试场景
- 单元测试：UserInterface兼容性测试
- 集成测试：用户角色分配的完整流程
- 边缘案例：匿名用户和认证用户的处理差异

#### 依赖关系
- 需要：任务7（Role实体）
- 阻塞：任务15（UserRoleRepository）

---

## 第三阶段：Repository层（4个任务）

### 任务 11: RoleRepository实现

#### 描述
实现角色的数据访问层，提供优化的查询方法和关联数据获取。

#### 验收标准（基于 EARS）
- 当按code查询角色时，必须使用索引优化查询
- Repository必须提供角色关联用户数量的统计方法
- 必须支持角色删除前的依赖检查

#### TDD 实施步骤
1. **红色阶段**：编写Repository接口和查询方法的测试
2. **绿色阶段**：实现Repository类和基础查询方法
3. **重构阶段**：添加复杂查询和性能优化

#### 测试场景
- 单元测试：每个查询方法的SQL生成
- 集成测试：复杂关联查询的正确性
- 边缘案例：大数据量下的查询性能

#### 依赖关系
- 需要：任务7（Role实体）
- 阻塞：任务14（PermissionManager服务）

---

### 任务 12: PermissionRepository实现

#### 描述
实现权限的数据访问层，优化权限码查询和批量操作。

#### 验收标准（基于 EARS）
- 当查询用户权限时，必须使用单SQL优化查询
- Repository必须支持权限码的模糊匹配搜索
- 必须提供权限使用情况的统计方法

#### TDD 实施步骤
1. **红色阶段**：编写权限查询优化的测试
2. **绿色阶段**：实现Repository和性能优化查询
3. **重构阶段**：添加缓存支持和批量操作

#### 测试场景
- 单元测试：查询构建器的SQL正确性
- 集成测试：用户权限查询的单SQL验证
- 边缘案例：权限码格式异常的处理

#### 依赖关系
- 需要：任务8（Permission实体）
- 阻塞：任务14（PermissionManager服务）

---

### 任务 13: UserRoleRepository实现

#### 描述
实现用户-角色关联的数据访问，优化用户权限的聚合查询。

#### 验收标准（基于 EARS）
- 当获取用户权限时，必须通过JOIN实现单次查询
- Repository必须支持批量用户角色分配
- 必须提供用户角色变更历史的查询接口

#### TDD 实施步骤
1. **红色阶段**：编写用户权限聚合查询的测试
2. **绿色阶段**：实现优化的JOIN查询和批量操作
3. **重构阶段**：添加查询缓存和性能监控

#### 测试场景
- 单元测试：JOIN查询的SQL生成验证
- 集成测试：多角色用户的权限去重测试
- 边缘案例：循环角色关系的检测和处理

#### 依赖关系
- 需要：任务10（UserRole实体）
- 阻塞：任务14（PermissionManager服务）

---

### 任务 14: Repository性能优化

#### 描述
对所有Repository进行性能优化，包括查询优化、索引使用和缓存策略。

#### 验收标准（基于 EARS）
- 当执行用户权限查询时，响应时间必须≤50ms
- Repository必须有效利用数据库索引
- 批量操作必须支持事务和回滚

#### TDD 实施步骤
1. **红色阶段**：编写性能基准测试
2. **绿色阶段**：实现查询优化和批量操作
3. **重构阶段**：添加性能监控和自动化测试

#### 测试场景
- 单元测试：查询执行计划的验证
- 集成测试：大数据量下的性能基准
- 边缘案例：数据库连接异常的处理

#### 依赖关系
- 需要：任务11-13（所有Repository）
- 阻塞：任务15（PermissionManager服务）

---

## 第四阶段：核心服务（5个任务）

### 任务 15: PermissionManager服务实现

#### 描述
实现PermissionManagerInterface的核心业务逻辑，提供所有权限管理功能。

#### 验收标准（基于 EARS）
- 当分配角色给用户时，操作必须是幂等的
- 所有写操作必须在事务中执行
- 必须支持批量操作并提供详细的执行报告

#### TDD 实施步骤
1. **红色阶段**：编写接口契约的测试用例
2. **绿色阶段**：实现基础的CRUD操作
3. **重构阶段**：添加事务支持、事件分发和审计日志

#### 测试场景
- 单元测试：每个接口方法的幂等性和事务性
- 集成测试：复杂业务场景的端到端测试
- 边缘案例：并发操作和事务冲突的处理

#### 依赖关系
- 需要：任务11-14（所有Repository和优化）
- 阻塞：任务16（PermissionVoter）、任务20-23（CLI命令）

---

### 任务 16: PermissionVoter实现

#### 描述
实现Symfony Security Voter，集成权限检查到Symfony Security体系。

#### 验收标准（基于 EARS）
- 当权限以PERMISSION_*格式时，Voter必须处理
- 对非目标权限必须返回ACCESS_ABSTAIN
- 必须记录所有权限检查的审计日志

#### TDD 实施步骤
1. **红色阶段**：编写Voter行为的单元测试
2. **绿色阶段**：实现supports()和voteOnAttribute()方法
3. **重构阶段**：优化性能和添加详细的日志记录

#### 测试场景
- 单元测试：Voter决策逻辑的完整测试
- 集成测试：与Symfony Security的集成测试
- 边缘案例：匿名用户和权限缓存的处理

#### 依赖关系
- 需要：任务15（PermissionManager服务）
- 阻塞：任务19（Symfony Security集成测试）

---

### 任务 17: AuditLogger服务实现

#### 描述
实现审计日志服务，记录所有权限变更和检查操作。

#### 验收标准（基于 EARS）
- 当执行权限变更时，必须记录结构化日志
- 日志必须包含操作ID、用户信息和时间戳
- 必须支持不同日志级别和格式化输出

#### TDD 实施步骤
1. **红色阶段**：编写日志记录和格式化的测试
2. **绿色阶段**：实现AuditLoggerInterface和日志写入
3. **重构阶段**：添加日志轮转和性能优化

#### 测试场景
- 单元测试：日志格式和内容的正确性
- 集成测试：高并发下的日志完整性
- 边缘案例：日志写入失败的处理

#### 依赖关系
- 需要：任务15（PermissionManager服务）
- 阻塞：任务24-26（事件系统）

---

### 任务 18: BulkOperationResult实现

#### 描述
实现批量操作结果的封装类，提供详细的执行报告和错误信息。

#### 验收标准（基于 EARS）
- 当批量操作完成时，必须提供成功/失败数量统计
- 必须包含每个失败项的详细错误信息
- 结果必须支持JSON序列化和查询接口

#### TDD 实施步骤
1. **红色阶段**：编写结果统计和错误收集的测试
2. **绿色阶段**：实现BulkOperationResult类
3. **重构阶段**：添加结果分析和报告生成功能

#### 测试场景
- 单元测试：统计计算和错误收集的正确性
- 集成测试：大批量操作结果的处理
- 边缘案例：内存使用和序列化性能

#### 依赖关系
- 需要：任务15（PermissionManager服务）
- 阻塞：任务20-23（CLI命令中的批量操作）

---

### 任务 19: 扩展接口实现

#### 描述
实现权限检查策略和审计策略的扩展接口，为未来功能预留扩展点。

#### 验收标准（基于 EARS）
- 当需要自定义权限检查时，必须能通过接口扩展
- 扩展接口必须与核心功能无缝集成
- 必须提供对象级权限检查的预留接口

#### TDD 实施步骤
1. **红色阶段**：编写扩展接口的集成测试
2. **绿色阶段**：实现扩展点接口和默认实现
3. **重构阶段**：添加扩展管理和配置支持

#### 测试场景
- 单元测试：扩展接口的契约验证
- 集成测试：自定义扩展的集成测试
- 边缘案例：扩展冲突和优先级处理

#### 依赖关系
- 需要：任务15-18（核心服务）
- 阻塞：无（扩展功能）

---

## 第五阶段：Symfony集成（4个任务）

### 任务 20: Bundle服务注册

#### 描述
完善Bundle的服务注册和依赖注入配置，确保所有服务正确注册到容器。

#### 验收标准（基于 EARS）
- 当Bundle加载时，所有服务必须正确注册到DI容器
- 环境变量配置必须正确绑定到服务
- Voter必须自动注册到Security组件

#### TDD 实施步骤
1. **红色阶段**：编写服务注册的容器测试
2. **绿色阶段**：完善Extension和服务配置文件
3. **重构阶段**：优化服务依赖关系和性能

#### 测试场景
- 单元测试：每个服务的注册和配置
- 集成测试：容器编译和服务解析
- 边缘案例：循环依赖和配置冲突

#### 依赖关系
- 需要：任务15-19（所有核心服务）
- 阻塞：任务21-23（集成测试任务）

---

### 任务 21: Symfony Security集成测试

#### 描述
验证RBAC Bundle与Symfony Security的完整集成，包括注解和方法调用。

#### 验收标准（基于 EARS）
- 当使用#[IsGranted]注解时，必须正确触发权限检查
- isGranted()方法必须返回正确的权限检查结果
- 必须与其他Voter正确共存

#### TDD 实施步骤
1. **红色阶段**：编写Security集成的功能测试
2. **绿色阶段**：创建集成测试环境和测试用例
3. **重构阶段**：添加边缘情况和性能测试

#### 测试场景
- 单元测试：Voter在Security决策中的行为
- 集成测试：完整的认证授权流程测试
- 边缘案例：多Voter环境下的决策测试

#### 依赖关系
- 需要：任务20（Bundle服务注册）
- 阻塞：无（独立验证）

---

### 任务 22: 事件分发集成

#### 描述
集成Symfony EventDispatcher，确保权限变更事件正确分发和处理。

#### 验收标准（基于 EARS）
- 当权限发生变更时，必须分发相应的事件
- 事件监听器必须能够正确接收和处理事件
- 必须支持异步事件处理

#### TDD 实施步骤
1. **红色阶段**：编写事件分发和监听的测试
2. **绿色阶段**：实现事件分发集成
3. **重构阶段**：添加异步支持和错误处理

#### 测试场景
- 单元测试：事件创建和分发的正确性
- 集成测试：监听器注册和事件处理
- 边缘案例：事件处理异常的恢复

#### 依赖关系
- 需要：任务24-26（事件系统）
- 阻塞：无（集成功能）

---

### 任务 23: 环境变量配置测试

#### 描述
验证所有环境变量配置的正确读取和默认值处理。

#### 验收标准（基于 EARS）
- 当环境变量存在时，必须正确读取和应用配置
- 当环境变量缺失时，必须使用合理的默认值
- 配置变更必须在运行时生效

#### TDD 实施步骤
1. **红色阶段**：编写环境变量读取的测试
2. **绿色阶段**：实现配置读取和验证逻辑
3. **重构阶段**：添加配置变更的热重载支持

#### 测试场景
- 单元测试：每个环境变量的读取和默认值
- 集成测试：配置在不同环境下的行为
- 边缘案例：无效配置值的处理

#### 依赖关系
- 需要：任务20（Bundle服务注册）
- 阻塞：无（配置验证）

---

## 第六阶段：CLI命令（4个任务）

### 任务 24: 基础CRUD命令

#### 描述
实现rbac:role和rbac:permission命令，提供角色和权限的基础管理功能。

#### 验收标准（基于 EARS）
- 当执行create命令时，必须创建唯一的角色/权限
- list命令必须支持筛选和分页显示
- delete命令必须执行前置依赖检查

#### TDD 实施步骤
1. **红色阶段**：编写CLI命令的输入输出测试
2. **绿色阶段**：实现Command类和基础功能
3. **重构阶段**：添加交互式确认和详细输出

#### 测试场景
- 单元测试：命令参数解析和验证
- 集成测试：命令执行的完整流程
- 边缘案例：无效输入和权限不足的处理

#### 依赖关系
- 需要：任务15（PermissionManager服务）
- 阻塞：任务25（批量命令）

---

### 任务 25: 权限分配命令

#### 描述
实现rbac:grant和rbac:revoke命令，支持权限的授予和撤销操作。

#### 验收标准（基于 EARS）
- 当执行grant命令时，必须验证角色和权限的存在
- revoke命令必须支持批量撤销操作
- 必须提供操作确认和撤销预览

#### TDD 实施步骤
1. **红色阶段**：编写权限操作命令的测试
2. **绿色阶段**：实现grant/revoke命令逻辑
3. **重构阶段**：添加批量操作和进度显示

#### 测试场景
- 单元测试：权限操作的幂等性验证
- 集成测试：复杂权限分配场景测试
- 边缘案例：并发操作和事务回滚

#### 依赖关系
- 需要：任务24（基础CRUD命令）
- 阻塞：任务26（批量命令）

---

### 任务 26: 批量操作命令

#### 描述
实现rbac:bulk命令，支持通过CSV或JSON文件进行批量权限操作。

#### 验收标准（基于 EARS）
- 当处理批量文件时，必须验证文件格式和数据完整性
- 必须提供详细的执行报告和失败分析
- 支持dry-run模式和操作预览

#### TDD 实施步骤
1. **红色阶段**：编写批量文件处理的测试
2. **绿色阶段**：实现文件解析和批量处理逻辑
3. **重构阶段**：添加进度条、错误恢复和报告生成

#### 测试场景
- 单元测试：文件格式解析和数据验证
- 集成测试：大批量数据的处理性能
- 边缘案例：文件损坏和处理中断的恢复

#### 依赖关系
- 需要：任务18（BulkOperationResult）、任务25（权限分配命令）
- 阻塞：任务27（权限扫描命令）

---

### 任务 27: 权限扫描命令

#### 描述
实现rbac:scan-permissions命令，扫描代码中使用的权限码并验证注册状态。

#### 验收标准（基于 EARS）
- 当扫描代码时，必须找到所有PERMISSION_*格式的权限引用
- 必须报告未注册的权限码和未使用的权限
- 支持多种文件格式和排除规则

#### TDD 实施步骤
1. **红色阶段**：编写代码扫描和分析的测试
2. **绿色阶段**：实现文件扫描和权限码提取
3. **重构阶段**：添加智能过滤和报告格式化

#### 测试场景
- 单元测试：权限码正则匹配的准确性
- 集成测试：大型代码库的扫描性能
- 边缘案例：动态权限码和注释中权限码的处理

#### 依赖关系
- 需要：任务26（批量操作命令）
- 阻塞：无（独立工具）

---

## 第七阶段：事件系统（3个任务）

### 任务 28: 事件类定义

#### 描述
创建所有RBAC相关的事件类，包括角色分配、权限授予等操作事件。

#### 验收标准（基于 EARS）
- 当创建事件时，必须包含完整的操作上下文信息
- 事件必须支持序列化和反序列化
- 必须包含操作ID和时间戳用于审计追踪

#### TDD 实施步骤
1. **红色阶段**：编写事件类的创建和属性测试
2. **绿色阶段**：实现所有事件类和基础属性
3. **重构阶段**：添加事件工厂和序列化支持

#### 测试场景
- 单元测试：每个事件类的属性和方法
- 集成测试：事件的序列化和传输
- 边缘案例：事件数据的完整性验证

#### 依赖关系
- 需要：任务3（异常类定义）
- 阻塞：任务29-30（事件监听和分发）

---

### 任务 29: 事件监听器实现

#### 描述
实现默认的事件监听器，用于审计日志记录和权限变更通知。

#### 验收标准（基于 EARS）
- 当事件被分发时，监听器必须正确处理和记录
- 必须支持监听器的优先级和条件过滤
- 监听器异常不能影响主业务流程

#### TDD 实施步骤
1. **红色阶段**：编写事件监听和处理的测试
2. **绿色阶段**：实现监听器类和事件处理逻辑
3. **重构阶段**：添加异常处理和性能优化

#### 测试场景
- 单元测试：监听器注册和事件处理
- 集成测试：多监听器环境下的执行顺序
- 边缘案例：监听器异常和事件重试机制

#### 依赖关系
- 需要：任务28（事件类定义）、任务17（AuditLogger服务）
- 阻塞：任务30（事件分发集成）

---

### 任务 30: 事件分发集成

#### 描述
将事件系统集成到核心服务中，确保所有权限操作都能正确分发事件。

#### 验收标准（基于 EARS）
- 当执行权限操作时，必须同步分发相应事件
- 事件分发失败不能影响核心业务操作
- 必须支持异步事件处理和事件持久化

#### TDD 实施步骤
1. **红色阶段**：编写事件分发集成的测试
2. **绿色阶段**：将事件分发集成到PermissionManager
3. **重构阶段**：添加异步支持和错误恢复

#### 测试场景
- 单元测试：事件分发的时机和内容
- 集成测试：端到端的事件处理流程
- 边缘案例：事件分发失败的回退策略

#### 依赖关系
- 需要：任务29（事件监听器）
- 阻塞：无（完整功能）

---

## 任务实施指导

### TDD实施原则
1. **红-绿-重构循环**：严格按照TDD流程实施每个任务
2. **测试优先**：总是先编写失败的测试，再实现功能
3. **小步推进**：每次只实现使当前测试通过的最小代码
4. **持续重构**：在保持测试通过的前提下优化代码结构

### 质量检查要求
每个任务完成后必须通过：
- PHPStan Level 8 静态分析（0错误）
- PHPUnit 测试套件（100%通过）  
- 代码覆盖率≥90%
- 符合PSR-12编码标准

### 依赖管理
- 严格按照依赖关系顺序执行任务
- 每个任务完成后运行相关测试验证
- 发现依赖冲突时立即停止并重新评估

### 文档要求
每个任务需要维护：
- 实施进度和决策记录
- API文档和使用示例  
- 测试报告和覆盖率统计
- 性能基准和优化记录

---

**RBAC Bundle的任务分解完成。所有26个任务都包含TDD步骤和测试场景，涵盖从基础架构到完整功能的全部实施内容。准备开始实施吗？**